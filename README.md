# Error-correction of streamflow predictions from a global hydrological model using random forests
This is the repository of the research article "Error-correction of streamflow predictions from a global hydrological model using random forests" by Youchen Shen, Jessica Ruijsch, Meng Lu, Edwin Sutanudjaja, Derek Karssenberg from Utrecht University, the Netherlands.

Here includes all observed data and simulated PCR-GLOBWB data, scripts for modelling and analysis for the research where random forests serve as an error-correction model for PCR-GLOBWB streamflow predictions. 

The folder of case_study/R/R_diffStation gives all the R and python scripts for this research project. 
## Raw data
Raw data is available in the directory **case_study/R/data/rawData**.
* **observed discharge (m^3/s)** obtained from the Global Runoff Data Center ([GRDC](http://www.bafg.de/GRDC)) in csv format
* **simulated discharge (m^3/s)** from the PCR-GLOBWB (calibrated & uncalibrated) in netCDF format
* **meteorological driving variables** averaged over the upstream grids of the gauging station in netCDF format
* **key hydrological state variables** from the PCR-GLOBWB (calibrated & uncalibrated) averaged over the upstream grids of the gauging station in netCDF format 

## Before starting
**case_study/R/data/rawData/stationLatLon.csv** indicates the location and basic geographic information of each station. This data was obtained from [GRDC station catalogues](https://www.bafg.de/GRDC/EN/02_srvcs/21_tmsrs/211_ctlgs/catalogues_node.html) (acessed date: 28/04/2020). 
With this station information, the following scripts are run for all stations that are indicated in this csv file and that have PCR-GLOBWB calibrated predictions in the folder [case_study/R/data/raw_data/PCR-Discharge/calibrated/](https://github.com/co822ee/PCR-GLOBWB_error-correction/tree/master/case_study/R/data/rawData/PCR-Discharge/calibrated).

## Data preprocessing

1. All **python scripts** extract variables values at desired locations, given latitude (x) and longitude (y), from the netCDF data.
2. **0_preprocessData_allProcesses.R** preprocesses the csv files created by the python in the previous step and creates new csv files that can be used for implementing RFs later. In the script you can choose to preprocess data from either the calibrated PCR-GLOBWB model or the one without calibration.

    The csv files generated by this script will be put in the data/preprocess folder and the results for simulation data from PCR-GLOBWB with different calibration configurations will be put in different subfolders.

## Implementing RF for all model configurations
**2_RF_allRFConfigurations.R** implements RFs to correct streamflow prediction errors in PCR-GLOBWB. 

At the top of the script you can choose 

* whether to implement for the calibrated/uncalibrated PCR-GLOBWB model 
* whether to include state variables as predictors in the random forests


This script runs the random forests for all stations provided and implements the following processes:

* tuning parameter and creating csv files of the tuning results (hyper_grid_[station].csv)
* determining optimal parameters based on OOB RMSEs
* creating csv files of goodness of fit values using both PCR-GLOBWB predictions and ones updated by the random forests (rf_eval.csv giving absolute goodness-of-fit values and rf_eval_r.csv giving relative goodness-of-fit values)
* creating csv files of variable importance results (variable_importance.csv)
* creating csv files of streamflow predictions updated by the random forests (rf_result_[station].csv)

The csv files generated by the script will be put in the data/analysis folder, and the results from different model configurations will be put in different subfolders.

## Visualizing results
* **3_visualization_RF_allConfiguration.R** generates the barplot showing model performance of all model configurations (either pure PCR-GLOBWB or hybrid models with PCR-GLOBWB followed by RF error-correction). 

* **3_visualize_hydrograph_all.R** generates not only time series plot of (observed & simulated) discharge and residuals for all configurations of the hybrid models but also scatterplots of residuals/predictions vs observations.


All the graphs generated by the above visualization scripts will be exported in the graph/RFresult_all folder.

## Function scripts
R scripts with names starting with 'function_' facilitate the model implementation.

## Contact
For any question regarding the source codes and data, please contact the correspondance author: Ms. Youchen Shen via email: co822ee@gmail.com or y.shen@uu.nl

## Citation
[![DOI](https://zenodo.org/badge/265265159.svg)](https://zenodo.org/badge/latestdoi/265265159)

