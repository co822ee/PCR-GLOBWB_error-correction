Here includes all raw observed and simulated data from PCR-GLOBWB, scripts for modelling and analysis for the research where random forests serve as an error-correction model for PCR-GLOBWB streamflow predictions. 

The folder of case_study/R/R_diffStation gives all the R and python scripts for this research project. 
## Raw data
Raw data is available in the directory **case_study/R/data/rawData**.
* **observed discharge (m^3/s)** obtained from the Global Runoff Data Center ([GRDC](http://www.bafg.de/GRDC)) in csv format
* **simulated discharge (m^3/s)** from the PCR-GLOBWB (calibrated & uncalibrated) in netCDF format
* **meteorological driving variables** averaged over the upstream grids of the gauging station in netCDF format
* **key hydrological state variables** from the PCR-GLOBWB (calibrated & uncalibrated) averaged over the upstream grids of the gauging station in netCDF format 

## Before starting
**case_study/R/data/rawData/stationLatLon.csv** indicates the location and basic geographic information of each station. This data was obtained from [GRDC station catalogues](https://www.bafg.de/GRDC/EN/02_srvcs/21_tmsrs/211_ctlgs/catalogues_node.html) (acessed date: 28/04/2020). 
With this station information, the following scripts are run for all stations indicated in this csv file.

## Data preprocessing

1. All **python scripts** extract variables values at desired locations, given latitude (x) and longitude (y), from the netCDF data.
2. **0_preprocessData_allProcesses.R** preprocesses the csv files created by the python in the previous step and creates new csv files that can be used for implementing RFs later. In the script you can choose to preprocess data from either the calibrated PCR-GLOBWB model or the one without calibration.

    The csv files generated by this script will be put in the data/preprocess folder and the results for simulation data from PCR-GLOBWB with different calibration configurations will be put in different subfolders.

## Implementing RF for all model configurations
**2_RF_allRFConfigurations.R** implements RFs to correct streamflow prediction errors in PCR-GLOBWB. 

At the top of the script you can choose 

* whether to implement for the calibrated/uncalibrated PCR-GLOBWB model 
* whether to include state variables as predictors in the random forests
* whether to repeat two-fold cross-validation in parameter tuning
* how many repeat in two-fold cross-validation. Note that it is recommended that there is no need to implement repeated two-fold cross-validation for the parameter tuning, since it does not greatly influence the performance of random forests.


This script runs the random forests for all stations provided and implements the following processes:

* tuning parameter and creating csv files of the tuning results (hyper_grid_[station].csv)
* determining optimal parameters based on OOB RMSEs and cross-validation RMSEs
* creating csv files of goodness of fit values using both PCR-GLOBWB predictions and ones updated by the random forests (rf_eval.csv giving absolute goodness-of-fit values and rf_eval_r.csv giving relative goodness-of-fit values)
* creating csv files of variable importance results (variable_importance.csv)
* creating csv files of streamflow predictions updated by the random forests (rf_result_[station].csv)

The csv files generated by the script will be put in the data/analysis folder, and the results from different model configurations will be put in different subfolders.

## Visualizing results
* **3_visualization_RF_allConfiguration.R** generates the barplot showing model performance of all model configurations (either pure PCR-GLOBWB or hybrid models with PCR-GLOBWB followed by RF error-correction). 

* **3_visualize_hydrograph_all.R** generates not only time series plot of (observed & simulated) discharge and residuals for all configurations of the hybrid models but also scatterplots of residuals/predictions vs observations.
* **3_visualize_hydrograph_all_calibr-wise.R**, unlike 3_visualize_hydrograph_all.R for the hybrid models, plots time series of (observed & simulated) discharge and residuals for the pure PCR-GLOBWB models (calibrated and uncalibrated). 

All the graphs generated by the above visualization scripts will be exported in the graph/RFresult_all folder.


### Further test
**4_testRFTransferability.R** tests the transferability of this error-correction RF trained for one catchment to another catchment. 


### Function scripts
R scripts with names starting with 'function_'


## Acknowledgement
This was a MSc guided research under the supervision of Prof. Dr. Derek Karssenberg and reviewed by Dr. Meng Lu at the Department of Physical Geography at Utrecht University. Jessica Ruijsch provided the streamflow observations and simulated data from the PCR-GLOBWB model. Without their contribution and technical support, this research would not have been possible.